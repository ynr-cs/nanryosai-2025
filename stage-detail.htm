<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ステージ詳細 | 南陵祭'25</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        /* 既存のCSSは変更なし */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');:root{--header-height:80px;--primary-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--accent-gradient:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);--bg-gradient:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--sidenav-width:320px;--shadow-medium:0 15px 50px rgba(0,0,0,0.15);--shadow-strong:0 20px 60px rgba(0,0,0,0.2)}*{-ms-box-sizing:border-box;box-sizing:border-box;margin:0;padding:0}body{background:var(--bg-gradient);color:#fff;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;min-height:100vh;overflow-x:hidden;padding-top:var(--header-height);position:relative}body.sidenav-open{overflow:hidden}body::before{background:radial-gradient(circle at 20% 20%,rgba(255,255,255,0.1) 0%,transparent 40%),radial-gradient(circle at 80% 80%,rgba(255,255,255,0.1) 0%,transparent 40%);content:'';height:100%;left:0;pointer-events:none;position:fixed;top:0;width:100%;z-index:-1}main{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;position:relative;z-index:2}.content-wrapper{margin:0 auto;max-width:960px;padding:40px 20px}.site-header{background:rgba(255,255,255,0.1);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.2);-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-ms-flexbox;display:flex;height:var(--header-height);left:0;padding:0 80px 0 30px;position:fixed;top:0;-webkit-transition:all .4s cubic-bezier(.23,1,.32,1);-o-transition:all .4s cubic-bezier(.23,1,.32,1);transition:all .4s cubic-bezier(.23,1,.32,1);width:100%;z-index:100}.site-header.hidden{-webkit-transform:translateY(-100%);-ms-transform:translateY(-100%);transform:translateY(-100%);opacity:0}.site-title a{-webkit-animation:float 6s ease-in-out infinite;animation:float 6s ease-in-out infinite;background:-webkit-gradient(linear,left top,right bottom,from(#fff),to(#e8f4f8));background:-o-linear-gradient(45deg,#fff,#e8f4f8);background:linear-gradient(45deg,#fff,#e8f4f8);background-clip:text;font-size:1.8em;font-weight:700;text-decoration:none;-webkit-transition:all .3s ease;-o-transition:all .3s ease;transition:all .3s ease;-webkit-text-fill-color:transparent;-webkit-background-clip:text}.desktop-nav{margin-left:auto}.desktop-nav ul{-ms-flex-pack:distribute;display:-webkit-box;display:-ms-flexbox;display:flex;gap:30px;list-style:none}.desktop-nav a{border-radius:25px;color:rgba(255,255,255,0.9);font-weight:500;padding:10px 20px;position:relative;text-decoration:none;-webkit-transition:all .3s ease;-o-transition:all .3s ease;transition:all .3s ease}.desktop-nav a::before{background:rgba(255,255,255,0.1);border-radius:25px;content:'';height:100%;left:0;opacity:0;position:absolute;top:0;-webkit-transition:opacity .3s ease;-o-transition:opacity .3s ease;transition:opacity .3s ease;width:100%}.desktop-nav a:hover{-webkit-transform:translateY(-2px);-ms-transform:translateY(-2px);transform:translateY(-2px);color:#fff}.desktop-nav a:hover::before{opacity:1}.hamburger-menu{-ms-flex-align:center;-ms-flex-direction:column;-ms-flex-pack:center;-webkit-box-align:center;-webkit-box-direction:normal;-webkit-box-pack:center;align-items:center;background:var(--accent-gradient);-webkit-box-shadow:var(--shadow-medium);box-shadow:var(--shadow-medium);border-radius:50%;cursor:pointer;display:-webkit-box;display:-ms-flexbox;display:flex;flex-direction:column;gap:4px;height:50px;justify-content:center;position:fixed;right:30px;top:20px;-webkit-transition:all .4s cubic-bezier(.23,1,.32,1);-o-transition:all .4s cubic-bezier(.23,1,.32,1);transition:all .4s cubic-bezier(.23,1,.32,1);width:50px;z-index:300}.hamburger-menu:hover{-webkit-transform:scale(1.1) rotate(5deg);-ms-transform:scale(1.1) rotate(5deg);transform:scale(1.1) rotate(5deg);-webkit-box-shadow:var(--shadow-strong);box-shadow:var(--shadow-strong)}.hamburger-menu .bar{background-color:#fff;border-radius:2px;height:2px;-webkit-transition:all .4s cubic-bezier(.23,1,.32,1);-o-transition:all .4s cubic-bezier(.23,1,.32,1);transition:all .4s cubic-bezier(.23,1,.32,1);width:22px}body.sidenav-open .hamburger-menu{background:#fff;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}body.sidenav-open .hamburger-menu .bar{background-color:#2c3e50}body.sidenav-open .hamburger-menu .bar1{-webkit-transform:translateY(6px) rotate(45deg);-ms-transform:translateY(6px) rotate(45deg);transform:translateY(6px) rotate(45deg)}body.sidenav-open .hamburger-menu .bar2{-webkit-transform:scaleX(0);-ms-transform:scaleX(0);transform:scaleX(0);opacity:0}body.sidenav-open .hamburger-menu .bar3{-webkit-transform:translateY(-6px) rotate(-45deg);-ms-transform:translateY(-6px) rotate(-45deg);transform:translateY(-6px) rotate(-45deg)}.sidenav{background:rgba(0,0,0,0.2);-webkit-backdrop-filter:blur(30px);backdrop-filter:blur(30px);border-left:1px solid rgba(255,255,255,0.2);height:100%;max-width:90vw;padding:100px 30px 30px;position:fixed;right:0;top:0;-webkit-transform:translateX(100%);-ms-transform:translateX(100%);transform:translateX(100%);-webkit-transition:-webkit-transform .5s cubic-bezier(.23,1,.32,1);-o-transition:transform .5s cubic-bezier(.23,1,.32,1);transition:transform .5s cubic-bezier(.23,1,.32,1);transition:transform .5s cubic-bezier(.23,1,.32,1),-webkit-transform .5s cubic-bezier(.23,1,.32,1);width:var(--sidenav-width);z-index:200}body.sidenav-open .sidenav{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidenav ul{list-style:none}.sidenav li{margin-bottom:8px;opacity:0;-webkit-transform:translateX(30px);-ms-transform:translateX(30px);transform:translateX(30px);-webkit-transition:opacity .4s ease,-webkit-transform .4s ease;-o-transition:opacity .4s ease,transform .4s ease;transition:opacity .4s ease,transform .4s ease}body.sidenav-open .sidenav li{opacity:1;-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}body.sidenav-open .sidenav li:nth-child(1){-webkit-transition-delay:.1s;-o-transition-delay:.1s;transition-delay:.1s}body.sidenav-open .sidenav li:nth-child(2){-webkit-transition-delay:.15s;-o-transition-delay:.15s;transition-delay:.15s}body.sidenav-open .sidenav li:nth-child(3){-webkit-transition-delay:.2s;-o-transition-delay:.2s;transition-delay:.2s}body.sidenav-open .sidenav li:nth-child(4){-webkit-transition-delay:.25s;-o-transition-delay:.25s;transition-delay:.25s}body.sidenav-open .sidenav li:nth-child(5){-webkit-transition-delay:.3s;-o-transition-delay:.3s;transition-delay:.3s}body.sidenav-open .sidenav li:nth-child(6){-webkit-transition-delay:.35s;-o-transition-delay:.35s;transition-delay:.35s}body.sidenav-open .sidenav li:nth-child(7){-webkit-transition-delay:.4s;-o-transition-delay:.4s;transition-delay:.4s}.sidenav a{border-radius:15px;color:rgba(255,255,255,0.9);display:block;font-size:1.1em;font-weight:500;padding:18px 25px;text-decoration:none;-webkit-transition:all .3s cubic-bezier(.23,1,.32,1);-o-transition:all .3s cubic-bezier(.23,1,.32,1);transition:all .3s cubic-bezier(.23,1,.32,1)}.sidenav a:hover{background:rgba(255,255,255,0.1);-webkit-transform:translateX(10px);-ms-transform:translateX(10px);transform:translateX(10px);color:#fff}.sidenav .about-us{border-top:1px solid rgba(255,255,255,0.2);margin-top:40px;padding-top:30px}.sidenav .about-us a{color:rgba(255,255,255,0.6);font-size:1em}.page-overlay{background-color:transparent;height:100%;left:0;pointer-events:none;position:fixed;top:0;-webkit-transition:background-color .5s;-o-transition:background-color .5s;transition:background-color .5s;width:100%;z-index:150}body.sidenav-open .page-overlay{background-color:rgba(0,0,0,0.6);pointer-events:auto}.site-footer{background:rgba(0,0,0,0.2);color:rgba(255,255,255,0.8);font-size:.9em;padding:30px 20px;text-align:center}@-webkit-keyframes float{0%,100%{-webkit-transform:translateY(0);transform:translateY(0)}50%{-webkit-transform:translateY(-10px);transform:translateY(-10px)}}@keyframes float{0%,100%{-webkit-transform:translateY(0);transform:translateY(0)}50%{-webkit-transform:translateY(-10px);transform:translateY(-10px)}}@media (max-width:900px){.desktop-nav{display:none}.site-header{padding:0 80px 0 20px}.hamburger-menu{height:45px;right:20px;width:45px}}.header-bg{background-position:50%;background-size:cover;height:400px;left:0;position:absolute;top:0;width:100%;z-index:1}.header-bg::after{background:rgba(0,0,0,0.5);content:'';height:100%;left:0;position:absolute;top:0;width:100%}.page-title-section{-ms-flex-align:center;-webkit-box-align:center;align-items:center;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;min-height:400px;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;position:relative;text-align:center;z-index:3}
        .page-title { font-size: 2.8em; font-weight: 700; line-height: 1.2; text-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .page-group-name { font-size: 1.2em; font-weight: 500; margin-bottom: 5px; color: rgba(255,255,255,0.7); }
        .page-catchphrase{font-size:1.5em;font-weight:400;max-width:600px;opacity:0.9; margin-top: 10px;}
        .summary-section{-webkit-box-shadow:0 10px 40px rgba(0,0,0,0.1);box-shadow:0 10px 40px rgba(0,0,0,0.1);background:rgba(0,0,0,0.25);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);border-radius:20px;display:-webkit-box;display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:20px;margin-top:-80px;margin-bottom:40px;padding:30px;position:relative;z-index:4}.summary-item{-ms-flex-positive:1;-webkit-box-flex:1;flex-grow:1;min-width:200px}.summary-item strong{display:block;font-size:1.1em;margin-bottom:5px;opacity:0.9}.summary-item span{font-size:1.3em;font-weight:700}.tabs{-webkit-box-pack:center;-ms-flex-pack:center;border-bottom:2px solid rgba(255,255,255,0.2);display:-webkit-box;display:-ms-flexbox;display:flex;gap:30px;justify-content:center;margin-bottom:30px}.tab-button{-webkit-transition:all .3s;-o-transition:all .3s;transition:all .3s;background:transparent;border:none;border-bottom:3px solid transparent;color:#fff;cursor:pointer;font-size:1.2em;font-weight:600;opacity:0.7;padding:15px 0}.tab-button.active{border-bottom-color:#fff;opacity:1}.tab-content{-webkit-animation:fadeIn .5s;animation:fadeIn .5s;display:none;padding:20px;background:rgba(0,0,0,0.15);border-radius:15px}.tab-content.active{display:block}.gallery{display:-ms-grid;display:grid;gap:15px;-ms-grid-columns:(minmax(200px,1fr))[auto-fit];grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}.gallery img{border-radius:10px;-webkit-box-shadow:0 5px 15px rgba(0,0,0,0.2);box-shadow:0 5px 15px rgba(0,0,0,0.2);height:auto;-webkit-transition:-webkit-transform .3s;-o-transition:transform .3s;transition:transform .3s;transition:transform .3s,-webkit-transform .3s;width:100%}.gallery img:hover{-webkit-transform:scale(1.05);-ms-transform:scale(1.05);transform:scale(1.05)}
        .map-container { position: relative; width: 100%; height: 450px; border-radius: 15px; overflow: hidden; background: rgba(0,0,0,0.2); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #mini-map { width: 100%; height: 100%; background-color: transparent; }
        .project-marker { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 8px 12px; box-shadow: var(--shadow-medium); text-align: center; color: white; cursor: pointer; transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1); transform: translate(-50%, -50%); }
        .project-marker:hover { transform: translate(-50%, -50%) scale(1.1); box-shadow: var(--shadow-strong); background: rgba(255, 255, 255, 0.2); }
        .project-marker .marker-name { font-size: 14px; font-weight: 700; white-space: nowrap; }
        .project-marker .marker-id { font-size: 11px; font-weight: 400; opacity: 0.8; white-space: nowrap; }
        .project-marker.highlight { background: var(--accent-gradient); box-shadow: 0 5px 20px rgba(0, 242, 254, 0.3); border-color: rgba(255, 255, 255, 0.4); transform: translate(-50%, -50%) scale(1.15); }
        .project-marker.highlight:hover { transform: translate(-50%, -50%) scale(1.2); }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out { background: rgba(255, 255, 255, 0.1) !important; backdrop-filter: blur(10px) !important; color: white !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 50% !important; width: 30px !important; height: 30px !important; line-height: 30px !important; transition: all 0.3s ease !important; }
        .leaflet-popup-content-wrapper { background: rgba(255, 255, 255, 0.15) !important; backdrop-filter: blur(20px) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 16px !important; box-shadow: var(--shadow-strong) !important; }
        .leaflet-popup-content { color: white !important; margin: 15px 20px !important; }
        .leaflet-popup-tip { background: rgba(255, 255, 255, 0.15) !important; }
        .leaflet-popup-close-button { color: white !important; padding: 8px 8px 0 0 !important; }
        .popup-content h3 { font-size: 1.2em; margin-bottom: 5px; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .popup-content p { font-size: 0.9em; opacity: 0.9; margin-bottom: 15px; }
        .popup-content .detail-button { display: inline-block; text-decoration: none; color: white; font-weight: 500; padding: 10px 20px; border-radius: 25px; background: var(--accent-gradient); transition: all 0.3s ease; }
        .popup-content .detail-button:hover { transform: scale(1.05); }
        .floor-display-overlay { position: absolute; bottom: 20px; left: 20px; z-index: 800; background: rgba(0,0,0,0.5); color: white; padding: 10px 20px; border-radius: 10px; font-size: 1.5em; font-weight: 700; backdrop-filter: blur(5px); }
        .map-link-button { display: block; background: var(--secondary-gradient); color: white; padding: 12px 30px; border-radius: 50px; text-decoration: none; font-weight: 600; font-size: 1em; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; text-align: center; margin-top: 20px; }
        .map-link-button:hover { transform: scale(1.05); }

        /* ▼▼▼【追加】タイムテーブル用のCSS ▼▼▼ */
        .timetable-table { border-collapse: collapse; width: 100%; }
        .timetable-table tr.current-performance { background-color: rgba(255,255,255,0.1); }
        .timetable-table td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .timetable-table .time { font-weight: 700; white-space: nowrap; padding-right: 25px; }
        .timetable-table .name a { color: white; text-decoration: none; font-weight: 600; transition: color 0.3s; }
        .timetable-table .name a:hover { color: rgba(255,255,255,0.7); }
        .timetable-table tr.current-performance .name a { font-weight: 700; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        /* ▲▲▲【追加】タイムテーブル用のCSS ▲▲▲ */
        
        @-webkit-keyframes fadeIn{from{opacity:0;-webkit-transform:translateY(10px);transform:translateY(10px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes fadeIn{from{opacity:0;-webkit-transform:translateY(10px);transform:translateY(10px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}
    </style>
</head>
<body>
    <header class="site-header"></header>
    <div class="hamburger-menu"> <span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span> </div> <div class="page-overlay"></div>
    <nav class="sidenav"></nav>
    
    <main>
        <div id="header-bg" class="header-bg"></div>
        <div class="page-title-section">
            <h1 id="project-name" class="page-title">読み込み中...</h1>
            <p id="project-catchphrase" class="page-catchphrase"></p>
        </div>
        <div class="content-wrapper">
            <section id="summary-section" class="summary-section" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"></section>
            <section class="content-body">
                <div id="tabs" class="tabs"></div>
                <div id="tab-contents" class="tab-contents"></div>
            </section>
        </div>
    </main>

    <footer class="site-footer"></footer>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script defer src="data.js"></script>
    <script defer>
        document.addEventListener('DOMContentLoaded', function() {
            // (テンプレート共通処理は変更なし)
            const body = document.body; const hamburger = document.querySelector('.hamburger-menu'); const overlay = document.querySelector('.page-overlay'); function toggleSidenav() { body.classList.toggle('sidenav-open'); } hamburger.addEventListener('click', toggleSidenav); overlay.addEventListener('click', toggleSidenav); let lastScrollTop = 0; const header = document.querySelector('.site-header'); if (header) { const headerHeight = header.offsetHeight; window.addEventListener('scroll', function() { let scrollTop = window.pageYOffset || document.documentElement.scrollTop; if (scrollTop > lastScrollTop && scrollTop > headerHeight) { header.classList.add('hidden'); } else { header.classList.remove('hidden'); } lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; }); }
            const siteHeader = document.querySelector('.site-header'); const siteFooter = document.querySelector('.site-footer'); const sidenav = document.querySelector('.sidenav'); if (siteHeader) { siteHeader.innerHTML = `<div class="site-title"><a href="index.htm">南陵祭'25</a></div> <nav class="desktop-nav"><ul><li><a href="about.htm">概要</a></li><li><a href="projects-list.htm">企画一覧</a></li><li><a href="stage-list.htm">ステージ発表</a></li><li><a href="map.htm">校内マップ</a></li><li><a href="access.htm">アクセス</a></li></ul></nav>`; } if (sidenav) { sidenav.innerHTML = `<ul><li><a href="about.htm">概要</a></li><li><a href="projects-list.htm">企画一覧</a></li><li><a href="stage-list.htm">ステージ発表</a></li><li><a href="map.htm">校内マップ</a></li><li><a href="access.htm">アクセス</a></li><li class="about-us"><a href="about-us.htm">About Us</a></li></ul>`; } if (siteFooter) { siteFooter.innerHTML = `<p>&copy; 2024 横浜南陵高校 コンピューター科学部</p>`; }

            // === このページ固有の処理 ===
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            // ★★★ 変更点(1)：ステージデータ(stageData)からも企画を探すように変更 ★★★
            const project = (typeof stageData !== 'undefined' ? stageData.find(s => s.id === projectId) : null) || (typeof projectData !== 'undefined' ? projectData.find(p => p.id === projectId) : null);

            if (project) {
                document.title = project.name + " | 南陵祭'25";
                document.getElementById('header-bg').style.backgroundImage = `url(${project.image})`;
                document.getElementById('project-name').innerText = project.name;
                document.getElementById('project-catchphrase').innerText = project.catchphrase || '';
                const summary = document.getElementById('summary-section');
                summary.innerHTML = `<div class="summary-item"><strong>場所</strong><span>${project.place}</span></div><div class="summary-item"><strong>時間</strong><span>${project.hours || project.time || '終日'}</span></div><div class="summary-item"><strong>タグ</strong><span>${(project.tags || []).join(', ')}</span></div>`;
                
                const tabsContainer = document.getElementById('tabs');
                const contentsContainer = document.getElementById('tab-contents');
                
                let tabsHTML = `<button class="tab-button active" data-tab="info">基本情報</button>`;
                let contentsHTML = `<div class="tab-content active" id="info"><p>${project.description || '詳細は当日をお楽しみに！'}</p></div>`;

                if (project.contentType === 'gallery' && project.gallery && project.gallery.length > 0) {
                    tabsHTML += `<button class="tab-button" data-tab="gallery">ギャラリー</button>`;
                    contentsHTML += `<div class="tab-content" id="gallery"><div class="gallery">${project.gallery.map(imgUrl => `<img src="${imgUrl}" alt="ギャラリー画像">`).join('')}</div></div>`;
                }

                // ▼▼▼【変更点②】ここから：メニューの代わりにタイムテーブルタブを追加 ▼▼▼
                const isStagePerformance = typeof stageData !== 'undefined' && stageData.some(s => s.id === project.id);
                if (isStagePerformance) {
                    tabsHTML += `<button class="tab-button" data-tab="timetable">タイムテーブル</button>`;
                    const timetableHTML = stageData
                        .sort((a, b) => (a.time || "").localeCompare(b.time || "")) // 時間で並び替え
                        .map(item => `
                        <tr class="${item.id === project.id ? 'current-performance' : ''}">
                            <td class="time">${item.time}</td>
                            <td class="name"><a href="stage-detail.htm?id=${item.id}">${item.name}</a></td>
                        </tr>
                    `).join('');
                    contentsHTML += `<div class="tab-content" id="timetable"><table class="timetable-table">${timetableHTML}</table></div>`;
                }
                // ▲▲▲【変更点②】ここまで ▲▲▲
                
                let locationData = project; 
                const allProjects = [...(window.projectData || []), ...(window.stageData || [])];
                if(project.locationId) { const representative = allProjects.find(p => p.locationId === project.locationId && p.mapX != null); if(representative) locationData = representative; }
                
                if(locationData.floor && locationData.mapX !== undefined && locationData.mapY !== undefined){
                    tabsHTML += `<button class="tab-button" data-tab="map">マップ</button>`;
                    const mapLink = `map.htm#location=${locationData.id}`;
                    contentsHTML += `
                        <div class="tab-content" id="map">
                            <div class="map-container">
                                <div id="mini-map"></div>
                                <div class="floor-display-overlay">${locationData.floor}F</div>
                            </div>
                            <a href="${mapLink}" class="map-link-button">校内マップで場所を確認</a>
                        </div>`;
                }
                
                tabsContainer.innerHTML = tabsHTML; 
                contentsContainer.innerHTML = contentsHTML;

                const tabButtons = document.querySelectorAll('.tab-button'); 
                const tabContents = document.querySelectorAll('.tab-content');
                tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); tabContents.forEach(content => content.classList.remove('active')); button.classList.add('active'); const targetContent = document.getElementById(button.dataset.tab); if(targetContent) targetContent.classList.add('active'); if (button.dataset.tab === 'map' && !document.getElementById('mini-map')._leaflet_id) { initializeMiniMap(project); } }); });
                // 初期表示時にマップタブがあればマップを初期化
                if(document.querySelector('.tab-button[data-tab="map"]')){
                    setTimeout(() => initializeMiniMap(project), 100);
                }

            } else {
                document.title = "エラー | 南陵祭'25"; 
                document.getElementById('project-name').innerText = '企画が見つかりません';
            }
        });
        
        const floorImageUrls = { 1: 'images/map-1f.png', 2: 'images/map-2f.png', 3: 'images/map-3f.png', 4: 'images/map-4f.png', 5: 'images/map-5f.png' };
        
        function initializeMiniMap(currentProject) { 
            let locationData = currentProject; 
            const allProjects = [...(window.projectData || []), ...(window.stageData || [])]; 
            if(currentProject.locationId) { const representative = allProjects.find(p => p.locationId === currentProject.locationId && p.mapX != null); if(representative) locationData = representative; }
            const imageUrl = floorImageUrls[locationData.floor]; 
            if (!imageUrl || !document.getElementById('mini-map')) { return; }
            
            const image = new Image();
            image.onload = function() {
                const imgWidth = this.width; const imgHeight = this.height; const bounds = [[0, 0], [imgHeight, imgWidth]];
                const map = L.map('mini-map', { crs: L.CRS.Simple, minZoom: -4, maxZoom: 5, zoomControl: false });
                L.imageOverlay(imageUrl, bounds).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                renderMiniMapMarkers(map, currentProject, locationData);
                map.setView([locationData.mapY, locationData.mapX], 1);
            };
            image.src = imageUrl;
        }

        function renderMiniMapMarkers(map, currentProject, locationData) { 
            const allProjects = [...(window.projectData || []), ...(window.stageData || [])];
            const projectsOnThisFloor = allProjects.filter(p => p.floor === locationData.floor && (p.mapX != null || p.locationId));
            projectsOnThisFloor.forEach(project => { 
                let projectLocation = project; 
                if(project.locationId) { const rep = allProjects.find(p => p.locationId === project.locationId && p.mapX != null); if(rep) projectLocation = rep; } 
                if(projectLocation.mapX === undefined || projectLocation.mapY === undefined) return;
                
                const isCurrent = (project.id === currentProject.id || (project.locationId && project.locationId === currentProject.locationId));
                const markerClass = isCurrent ? "project-marker highlight" : "project-marker";
                const markerHtml = `<div class="${markerClass}"><div class="marker-name">${project.name.split('「')[0]}</div><div class="marker-id">${(project.tags && project.tags.length > 1) ? project.tags[1] : ''}</div></div>`;
                const customIcon = L.divIcon({ className: '', html: markerHtml, iconSize: [null, null] });
                const marker = L.marker([projectLocation.mapY, projectLocation.mapX], { icon: customIcon }).addTo(map);

                // ▼▼▼【変更点③】ここから：ステージ企画ならstage-detail.htmにリンク ▼▼▼
                const isStage = typeof stageData !== 'undefined' && stageData.some(s => s.id === project.id);
                const detailPageUrl = isStage ? 'stage-detail.htm' : 'project-detail.htm';
                const popupHtml = `<div class="popup-content"><h3>${project.name}</h3><a href="${detailPageUrl}?id=${project.id}" class="detail-button">詳細を見る</a></div>`;
                // ▲▲▲【変更点③】ここまで ▲▲▲

                marker.bindPopup(popupHtml);
                if(isCurrent){ marker.openPopup(); }
            });
        }
    </script>
</body>
</html>
